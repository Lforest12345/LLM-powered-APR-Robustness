# Exploring and Lifting the Robustness of LLM-powered Automated Program Repair with Metamorphic Testing

## Datasets:
Two datasets are employed as our test subjects:
* Defects4J
* QuixBugs

## Code:
This repository includes the following code:

* Code for using AST to implement nine kinds of MRs: Located in the `` directory.
* Code for LLM-based code patch generation: Located in the `` directory, comprising code for LLaMA3-8B, LLaMA3-70B, Mistral Large, and CodeGemma-7B models. For GPT-3.5 and Gemini.
* Construction of test cases: Located in the `` directory.
* Code for training a CodeT5-based code editing model aiming at improving code readability: Located in the `` directory, which involves CodeT5-base⋆ and CodeT5-large⋆.

## Quick Start

### LLM code patch generation.

This step is designed to test the LLM's repair performance on the original datasets to build base samples. Navigate to the `LLM_test` directory. Before running the code, please perform different operations according to diffenrent datasets:

#### Defects4J: 

- Configuration Variables

  The corresponding code file is `LLM_test_Defects4J.py`. Before running the code, please modify the following variables according to your requirements:

  * `input_file`: Specify the file path of the input data of Defects4J, namely, `single_function_repair.json`, which located in the same directory.
  * `keylist`:  A list containing multiple keys can be used. You can fill in a certain number of API keys according to your used models and actual needs.
  * `llm_models`: A list of different LLM names. You can change the contents of this list to test multiple LLMS.
  * `output_dir`: You can change the field name according to the actual situation, as the output directory of the test results, for example, `fixed_code_mistrallarge`.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python LLM_test_Defects4J.py
  ```

#### QuixBugs: 

- Configuration Variables

  The corresponding code file is `LLM_test_QuixBugs.py`. Before running the code, please modify the following variables according to your requirements:

  * `input_file`: Specify the file path of the input data of Defects4J, namely, `single_function_repair.json`, which located in the same directory.
  * `keylist`:  A list containing multiple keys can be used. You can fill in a certain number of API keys according to your used models and actual needs.
  * `llm_models`: A list of different LLM names. You can change the contents of this list to test multiple LLMS.
  * `output_dir`: You can change the field name according to the actual situation, as the output directory of the generated results, for example, `fixed_code_mistrallarge`.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python LLM_test_QuixBugs.py
  ```

#### Pre-processing of generated patches

- Configuration Variables

 The corresponding code file is `pre-processing.py`. Before running the code, please modify the following variables according to your requirements:

  * `source_folder`: The output directory of the generated results in the previous step, for example, `fixed_code_mistrallarge`.
  * `target_folder`: The output directory of the results after pre-processing, for example, `fixed_code_mistrallarge_pre`.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python pre-processing.py
  ```

### Verify that the LLM generated the correct patch.

 Navigate to the `LLM_validation` directory.

#### Defects4J: 

- Configuration Variables

  The corresponding code file is `validate_Defects4J.py`. Before running the code, please modify the following variables according to your requirements:

  * `main_folder`: This directory holds the code patches generated by the LLM and ensures that all code patches have been pre-processed.
  * `loc_folder`:  This directory corresponds to the path of `location` directory in the Defects4J raw dataset, for example, `Defects4j/location`.
  * `input_file`: Specify the file path of the input data of Defects4J, namely, `single_function_repair.json`, which located in `LLM_test` directory.
  * `output_result `: You can change the field name according to the actual situation, as the output directory of the validation results, for example, `validation_result`.
  
- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python validate_Defects4J.py
  ```

#### QuixBugs: 

- Configuration Variables

  The corresponding file is `validate_QuixBugs.sh`. Before running the script, please modify the following variables according to your requirements:

  * `main_folder`: This directory holds the code patches generated by the LLM and ensures that all code patches have been pre-processed.
  * `loc_folder`:  This directory corresponds to the path of `location` directory in the Defects4J raw dataset, for example, `Defects4j/location`.
  * `input_file`: Specify the file path of the input data of Defects4J, namely, `single_function_repair.json`, which located in `LLM_test` directory.
  * `output_result `: You can change the field name according to the actual situation, as the output directory of the validation results, for example, `validation_result`.
  
- Running the Script

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding shell script to perform the task, for example:
  ```shell
  $ ./ validate_QuixBugs.sh
  ```
#### Construction of base samples
After the above process, we obtain 60 base samples from each dataset, where 15 samples for each LLM, namely Defect4J<sub>base</sub> and QuixBugs<sub>base</sub>. Details of the base sample construction results
are as follows:
![数据集采样结果](https://github.com/user-attachments/assets/1d25ea25-3347-452b-a844-b967c5dd0890)

### Implemention of Nine MRs Based on AST.
Navigate to the `AST` directory and execute the following code to implemnt MRs:

#### Defects4J: 

- Configuration Variables

  The corresponding code file is `per_Defects4J.py`. Before running the code, please modify the following variables according to your requirements:

  * `input_directory`: The directory of the results after pre-processing, for example, `fixed_code_mistrallarge_pre`.
  * `java_class_path`: The path to the Java library javaparser, for example, `javaparser-core-3.25.8.jar`, which located in the same directory.
  * `output_directory`: The path where the perturbed code patch is stored, for example, `perturbated_result_Defects4J`.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python per_Defects4J.py
  ```
  
#### QuixBugs: 

  The corresponding code file is `per_QuixBugs.py`. Before running the code, please modify the following variables according to your requirements:

  * `input_directory`: The path to the directory where the Java buggy program is stored in the QuixBugs dataset, for example, `QuixBugs/java_programs`.
  * `java_class_path`: The path to the Java library javaparser, for example, `javaparser-core-3.25.8.jar`, which located in the same directory.
  * `output_directory`: The path where the perturbed code patch is stored, for example, `perturbated_result_QuixBugs`.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python per_QuixBugs.py
  ```


### Experimental results.
After you have all the test cases, first perform the patch correctness test as Step `Verify that the LLM generated the correct patch`.

#### Experimental results of different RQs:

- Configuration Variables

  The corresponding code file is `analysis_Defects4J.py`, which located in the `Evaluation` directory. Before running the code, please modify the following variables according to your requirements:

  * `root_directory `: The path of the output directory of the validation results.
  * `result_file`: The path to store the txt file that counts the results of each RQ.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python analysis_Defects4J.py
  ```
  
#### QuixBugs: 

  The corresponding code file is `analysis_QuixBugs.py`. Before running the code, please modify the following variables according to your requirements:

  * `files_to_read`: The path of the output directory of the validation results.
  * `result_file`: The path to store the txt file that counts the results of each RQ.

- Running the Code

  Ensure that you have correctly set the variables mentioned above.

  Run the corresponding Python script to perform the task, for example:
  ```python
  $ python analysis_QuixBugs.py
  ```


### Calculate Automated Evaluation Metrics:

- Configuration Variables

  Before running the code, please modify the following variables according to your requirements:

  * `file`: Specify the file path containing the generated text, for example, `csgptnoexample.jsonl`.
  * `nlp_file_path`: Specify the file path containing the reference text for automated evaluation metrics, for example, `gptjavainnlp.jsonl`.

- Running the Code

  Ensure that you have correctly set the above variables. Run the corresponding Python script to perform the task of calculating automated evaluation metrics, for example:
  ```python
  $ python metrics.py
  ```

### Retrieve the Best Examples:
Enter the `tools` directory and choose the appropriate retrieval tool:

#### Lexical Retrieval of Best Examples
- Configuration Variables

  Before running the code, please modify the following variables according to your requirements:

  * `lan`: Specify the path of the language data file, for example, `java.jsonl`.
  * `train`: Specify the path of the training data file, for example, `javatrain.jsonl`.
  * `output_filename`: Specify the path of the output file, for example, `java_with_best.jsonl`.

- Running the Code

  Ensure that you have correctly set the above variables. Run the corresponding Python script to perform the lexical retrieval task, for example:
  ```python
  $ python lexical_retrieval.py
  ```

#### Semantic Retrieval of Best Examples
Semantic retrieval consists of two steps, vectorization, and finding the best examples:

- Step 1: Vectorization:

  - Configuration Variables
  
    Before running the code, please modify the following variables according to your requirements:

    - `lan`: Specify the path of the language data file, for example, `py1.jsonl`.
    - `output_file`: Specify the path of the output vector data file, for example, `vpy1no.jsonl`.

  - Running the Code
  
  Ensure that you have correctly set the above variables. Run the corresponding Python script to perform the vectorization task, for example:
  ```python
  $ python semantic_retrieval_vectorization.py
  ```

- Step 2: Finding the Best Examples:

  - Configuration Variables
  
    Before running the code, please modify the following variables according to your requirements:
  
    - `vlan`: Specify the path of the language vector data file, for example, `vpy1no.jsonl`.
    - `vtrain`: Specify the path of the training vector data file, for example, `encoded_diffspy2.jsonl`.
    - `output_file`: Specify the path of the output file containing the retrieved best matches, for example, `pybest_no_selectv.jsonl`.
    - `input_file`: Specify the file path being retrieved, for example, `pytrain_no_selectv.jsonl`.

  - Running the Code
  
  Ensure that you have correctly set the above variables. Run the corresponding Python script to perform the semantic retrieval task, for example:
  ```python
  $ python semantic_retrieval_find.py
  ```

## Contribution
Contributions to this project through Pull Requests or Issues are welcome.

## License
This project is licensed under the `MIT` License.
